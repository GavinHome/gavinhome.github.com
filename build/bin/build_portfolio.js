var fs = require('fs');
var render = require('json-templater/string');
var path = require('path');
var endOfLine = require('os').EOL;
const rootPath = path.resolve(__dirname, '../../');

var Components = require(path.join(rootPath, 'build/bin/portfolio_components.json'));
var OUTPUT_PATH = path.join(rootPath, 'themes/var/layout/_partial/portfolio/main.swig');
var item_content_template = 
`            <a class="{{className}}" href="{{path}}" data-fluidbox>
              <img src="{{path}}" alt="{{text}}">
            </a>`;
var item_template = `
        <div class="p-item p-item-{{count}} {{category}}">
{{content}}
        </div><!-- p-item -->`;

var MAIN_TEMPLATE = `/* Automatically generated by './build/bin/build_portfolio.js' */
<main class="portfolio-content">
	<section class="portfolio-section section">	
      <div class="portfolioContainer">		
{{list}}

      </div><!-- portfolioContainer -->
      
	</section><!-- portfolio-section -->
</main>
`;

var ComponentNames = Object.keys(Components);

var listTemplate = [];
ComponentNames.forEach(name => {
    var itemTemplate = [];
    var gruopsTemplate = [];
    var item = Components[name];
    item.group.forEach((group) => {
        gruopsTemplate.push(render(item_content_template, {
            path: group,
            text: item.category.join(' '),
            className: item.group.length > 1? 'img':''
        }))
    });

    itemTemplate.push(render(item_template, {
        content: gruopsTemplate.join('\n'),
        category: item.category.join(' '),
        count: gruopsTemplate.length
    }));

    listTemplate.push(`  ${itemTemplate}`);
});

var template = render(MAIN_TEMPLATE, {
  list: listTemplate.join('\n')
});

fs.writeFileSync(OUTPUT_PATH, template);
console.log('[build portfolio] DONE:', OUTPUT_PATH);

